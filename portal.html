<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Investor Portal</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:24px; line-height:1.45; color:#111 }
    h1 { margin-bottom:6px }
    .note { color:#666; font-size:14px; margin-bottom:16px }
    .tabs { display:flex; gap:8px; margin:16px 0 }
    .tab { padding:8px 12px; border:1px solid #ccc; background:#f9f9f9; cursor:pointer; border-radius:6px }
    .tab.active { background:#e0e7ff; font-weight:600 }
    .panel { display:none }
    .panel.active { display:block }
    .wrap { overflow-x:auto; border:1px solid #ddd; border-radius:6px; margin-top:8px; background:#fff }
    table { width:100%; border-collapse:collapse }
    th, td { border-bottom:1px solid #eee; padding:8px; text-align:left; white-space:nowrap; vertical-align:top }
    th { background:#f3f4f6 }
    img.thumb { width:64px; height:64px; object-fit:cover; border-radius:6px; border:1px solid #eee }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#e5fbe5; color:#065f46; font-size:12px }
    .pill.red { background:#fde7e7; color:#7f1d1d }
    .card { border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff }
  </style>
</head>
<body>
  <h1>Investor Portal</h1>
  <p class="note">Reads CSV files from <code>data/current/</code>. Update the CSVs in GitHub and refresh.</p>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="tasks">Tasks</button>
    <button class="tab" data-tab="labor">Labor</button>
    <button class="tab" data-tab="materials">Materials</button>
    <button class="tab" data-tab="invoices">Invoices</button>
  </div>

  <!-- TASKS -->
  <section id="tasks" class="panel active">
    <div class="wrap"><table id="tasksTable"></table></div>
  </section>

  <!-- LABOR -->
  <section id="labor" class="panel">
    <div class="wrap"><table id="laborTable"></table></div>
  </section>

  <!-- MATERIALS -->
  <section id="materials" class="panel">
    <div class="wrap"><table id="materialsTable"></table></div>
  </section>

  <!-- INVOICES -->
  <section id="invoices" class="panel">
    <div class="card">
      <div>Total Unpaid Balance: <span id="unpaidSum" class="pill red">â‚±0</span></div>
      <p class="note">Built automatically from rows with <strong>Status = Unpaid</strong> in Labor and Materials.</p>
    </div>
    <h3>Unpaid Labor</h3>
    <div class="wrap"><table id="unpaidLaborTable"></table></div>
    <h3 style="margin-top:18px">Unpaid Materials</h3>
    <div class="wrap"><table id="unpaidMaterialsTable"></table></div>
  </section>

<script>
  const BASE = '/CleoSept18';
  const paths = {
    tasks: BASE + '/data/current/tasks.csv',
    labor: BASE + '/data/current/labor.csv',
    materials: BASE + '/data/current/materials.csv'
  };

  // Tabs
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  async function csvToRows(url) {
    const res = await fetch(url + '?v=' + Date.now());
    if (!res.ok) return [];
    const text = (await res.text()).trim();
    if (!text) return [];
    return text.split(/\r?\n/).map(line => line.split(',').map(s => s.trim()));
  }

  function renderTable(elId, rows) {
    const el = document.getElementById(elId);
    if (!rows.length) { el.innerHTML = '<tr><td>No data</td></tr>'; return; }
    const [head, ...body] = rows;
    const lowerHead = head.map(h => h.toLowerCase());
    const thead = '<thead><tr>' + head.map(h => `<th>${h}</th>`).join('') + '</tr></thead>';
    const tbody = '<tbody>' + body.map(r => '<tr>' + r.map((c, i) => {
      const h = lowerHead[i];
      if (h === 'image' && c) {
        return `<td><a href="${c}" target="_blank"><img class="thumb" src="${c}" alt="img"></a></td>`;
      }
      if (/^https?:\/\//i.test(c)) return `<td><a href="${c}" target="_blank">open</a></td>`;
      return `<td>${c}</td>`;
    }).join('') + '</tr>').join('') + '</tbody>';
    el.innerHTML = thead + tbody;
  }

  function sumColumn(rows, columnName) {
    if (!rows.length) return 0;
    const [head, ...body] = rows;
    const idx = head.findIndex(h => h.toLowerCase() === columnName);
    if (idx === -1) return 0;
    return body.reduce((acc, r) => acc + (parseFloat(r[idx]) || 0), 0);
  }

  function filterUnpaid(rows) {
    if (!rows.length) return [];
    const [head, ...body] = rows;
    const iStatus = head.findIndex(h => h.toLowerCase() === 'status');
    return [head, ...body.filter(r => (r[iStatus] || '').toLowerCase() === 'unpaid')];
  }

  Promise.all([
    csvToRows(paths.tasks).then(r => renderTable('tasksTable', r)),
    csvToRows(paths.labor).then(r => {
      renderTable('laborTable', r);
      const unpaid = filterUnpaid(r);
      renderTable('unpaidLaborTable', unpaid);
      return sumColumn(unpaid, 'total');
    }),
    csvToRows(paths.materials).then(r => {
      renderT
